---
title: "Counterfactual Fairness Model"
author: "Simon Schrauth"
date: "`r Sys.Date()`"
output: html_document
---

# Counterfactual Fairness

## Goal

After executing this script, the counterfactual fairness/discrimination of the base model should be determined.

## Preparation
### Install packages

Installing rstan package (and the dependent StanHeaders package) from source (for additional information or in the case of installation problems see also <https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started>)

```{r}
install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```

```{r}
pacman::p_load(tidyverse, 
               here,
               fastDummies,
               dagitty,
               ggdag,
               rstan,
               wesanderson,
               ggdist,
               ggformula,
               knitr,
               kableExtra,
               magick)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

### Source Function Script
```{r}
source(file = here("02_scripts", "04_counterfactual", "00_counterfactual_functions.R"))
```

### Load data

```{r}
data = readRDS(here("01_data", "02_data_processed", "01_base_model",
                    "03_data.rds"))
```

### Prepare data

```{r}
data_counter = data %>% 
  select(Age = age,
         Sex = sex,
         Race = race,
         JuvFel = juv_fel_count,
         JuvMisd = juv_misd_count,
         Priors = priors_count,
         Crime = charge_degree,
         COMPAS = compas) %>% 
  dummy_cols(select_columns = c("Race", "Sex"),
             remove_first_dummy = FALSE,
             remove_selected_columns = TRUE) %>% 
  rename("Race_African_American" = "Race_African-American") %>% 
  mutate(Crime = ifelse(Crime == "F", 1, 0)) %>% 
  mutate(COMPAS = as.numeric(COMPAS)-1)

colors = wes_palette("Darjeeling1")
colors_discrete = rep(wes_palette("Darjeeling1"), 3)
```

## Build DAG (directed acyclic graph)

```{r}
dag = dagitty('dag {
  Alter [exposure,pos="0,-2"]
  Geschlecht [pos="0,-1"]
  Race [pos="0,0"]
  Straftaten [pos="0.5, -1.75"]
  Schwere [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JugOrdw [pos="0.5, -0.25"]
  JugStrft [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  
  Race -> Straftaten
  Race -> Schwere
  Race -> JugOrdw
  Race -> JugStrft
  Race -> COMPAS
  Geschlecht -> Straftaten
  Geschlecht -> Schwere
  Geschlecht -> JugOrdw
  Geschlecht -> JugStrft
  Geschlecht -> COMPAS
  Alter -> Straftaten
  Alter -> Schwere
  Alter -> JugOrdw
  Alter -> JugStrft
  Alter -> COMPAS
  U_D -> Straftaten
  U_D -> Schwere
  U_J -> JugOrdw
  U_J -> JugStrft
  U_D -> COMPAS
  }')

#tidy_dagitty(dag)

dag_plot = tidy_dagitty(dag) %>% 
  mutate(name = str_replace(name, "U_J", "U[J]")) %>% 
  mutate(name = str_replace(name, "U_D", "U[D]")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == "COMPAS"),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]"),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to != "COMPAS"),
                          curvature = 1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Geschlecht", "Alter")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name=="COMPAS"),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Straftaten", 
                                                         "Schwere",
                                                         "JugOrdw",
                                                         "JugStrft")),
                color = colors[4]) +
  geom_dag_text(size = 1.9, parse = TRUE) +
  theme_dag()

dag_plot
```

```{r}
dag_counter = dagitty('dag {
  Alter [exposure,pos="0,-2"]
  Geschlecht [pos="0,-1"]
  Race [pos="0,0"]
  Straftaten [pos="0.5, -1.75"]
  Schwere [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JugOrdw [pos="0.5, -0.25"]
  JugStrft [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  
  Alter_k [exposure,pos="4,-2"]
  Geschlecht_k [pos="4,-1"]
  Race_k [pos="4,0"]
  Straftaten_k [pos="3.5, -1.75"]
  Schwere_k [pos="3, -1.75"]
  JugOrdw_k [pos="3.5, -0.25"]
  JugStrft_k [pos="3,-0.25"]
  COMPAS_k [outcome,pos="2.5,-1"]
  
  Race -> Straftaten
  Race -> Schwere
  Race -> JugOrdw
  Race -> JugStrft
  Race -> COMPAS
  Geschlecht -> Straftaten
  Geschlecht -> Schwere
  Geschlecht -> JugOrdw
  Geschlecht -> JugStrft
  Geschlecht -> COMPAS
  Alter -> Straftaten
  Alter -> Schwere
  Alter -> JugOrdw
  Alter -> JugStrft
  Alter -> COMPAS
  U_D -> Straftaten
  U_D -> Schwere
  U_J -> JugOrdw
  U_J -> JugStrft
  U_D -> COMPAS
  
  Race_k -> Straftaten_k
  Race_k -> Schwere_k
  Race_k -> JugOrdw_k
  Race_k -> JugStrft_k
  Race_k -> COMPAS_k
  Geschlecht_k -> Straftaten_k
  Geschlecht_k -> Schwere_k
  Geschlecht_k -> JugOrdw_k
  Geschlecht_k -> JugStrft_k
  Geschlecht_k -> COMPAS_k
  Alter_k -> Straftaten_k
  Alter_k -> Schwere_k
  Alter_k -> JugOrdw_k
  Alter_k -> JugStrft_k
  Alter_k -> COMPAS_k
  U_D -> Straftaten_k
  U_D -> Schwere_k
  U_J -> JugOrdw_k
  U_J -> JugStrft_k
  U_D -> COMPAS_k
  }')

dag_counter_plot = tidy_dagitty(dag_counter) %>% 
  mutate(across(.cols = c(name, to),
                .fns = ~ str_replace(., "Geschlecht_k", "bold(!Geschlecht)")
                )
         ) %>% 
  mutate(across(.cols = c(name, to),
                .fns = ~ str_replace(., "_(\\w)", "[\\1]")
                )
         ) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == c("COMPAS", "COMPAS[k]")),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]" & to %in% c("JugOrdw", "JugStrft")),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to %in% c("Straftaten", "Schwere")),
                          curvature = 1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]" & to %in% c("JugOrdw[k]", "JugStrft[k]")),
                          curvature = 1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to %in% c("Straftaten[k]", "Schwere[k]")),
                          curvature = -1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Geschlecht", "Alter",
                                                         "Race[k]", "Alter[k]")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name == "bold(!Geschlecht)"),
                 color = colors[1]) +
  geom_dag_node(data = function(x) subset(x, name==c("COMPAS", "COMPAS[k]")),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Straftaten", 
                                                         "Schwere",
                                                         "JugOrdw",
                                                         "JugStrft",
                                                         "Straftaten[k]", 
                                                         "Schwere[k]",
                                                         "JugOrdw[k]",
                                                         "JugStrft[k]")),
                color = colors[4]) +
  geom_dag_text(size = 1.9, parse = TRUE) +
  theme_dag()

dag_counter_plot

```

```{r}
ggsave("01_dag.png",
       plot = dag_plot,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )

ggsave("01_dag_counter.png",
       plot = dag_counter_plot,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```

## Build Structural Causal Model via Bayesian Estimation

## with RStan (adapted code from <https://github.com/mkusner/counterfactual-fairness>)

### Base model (for estimating U_d and U_j)

#### Prepare data for base model

```{r}
data_base_protected = data_counter %>% 
  select(starts_with(c("Race_", "Sex_"))) 

n = nrow(data_counter)


data_base_list = list(N = n,
                      K = length(data_base_protected),
                      prot = data.matrix(data_base_protected),
                      age = data_counter[, "Age", drop = TRUE],
                      priors = data_counter[, "Priors", drop = TRUE],
                      crime = data_counter[, "Crime", drop = TRUE],
                      juvmisd = data_counter[, "JuvMisd", drop = TRUE],
                      juvfel = data_counter[, "JuvFel", drop = TRUE],
                      compas = data_counter[, "COMPAS", drop = TRUE])
```

#### Fit base model

```{r}
fit_base = stan(file = here("02_scripts", "04_counterfactual",
                            "02_counterfactual_model_base.stan"), 
                data = data_base_list, 
                iter = 2000, 
                chains = 4,
                seed = 219684725,
                verbose = TRUE)

params_base = extract(fit_base)
```

#### Save base model
```{r}
saveRDS(fit_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                    "01_model_base_fit.rds")
        )

saveRDS(params_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                    "02_model_base_params.rds")
        )
```

```{r}
fit_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                               "01_model_base_fit.rds")
        )

params_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                                  "02_model_base_params.rds")
        )
```

#### Check sampled U_d parameter distributions

```{r}
s = sample(seq(1,6172), 10)

param_dist = as.data.frame(params_base)[,s] %>% 
  pivot_longer(cols = everything())

param_dist %>% 
  ggplot(aes(x = name, y = value, fill = name)) +
  ggdist::stat_halfeye(
    adjust = 0.75,
    justification = -.05,
    .width = 0,
    point_colour = NA
     ) +
  guides(fill = "none") +
  coord_flip() 
```

#### Compute median and median absolute deviation (mad) of U_d and U_j distributions for all cases

```{r}
u_d = params_base %>% 
  as.data.frame() %>% 
  select(starts_with(c("u_d"))) %>% 
  summarise(across(.cols = everything(),
                   .fns = list(median = median, mad = mad),
                   .names = "{.col}-{.fn}"))  %>% 
  pivot_longer(cols = everything(),
               names_to = c("case", "metric"),
               names_sep = "-") %>% 
  mutate(case = as.numeric(str_replace(case, "u_d.(\\d*)", "\\1"))) %>% 
  pivot_wider(names_from = "metric",
              values_from = "value")

u_j = params_base %>% 
  as.data.frame() %>% 
  select(starts_with(c("u_j"))) %>% 
  summarise(across(.cols = everything(),
                   .fns = list(median = median, mad = mad),
                   .names = "{.col}-{.fn}")) %>% 
  pivot_longer(cols = everything(),
               names_to = c("case", "metric"),
               names_sep = "-") %>% 
  mutate(case = as.numeric(str_replace(case, "u_j.(\\d*)", "\\1"))) %>% 
  pivot_wider(names_from = "metric",
              values_from = "value")
```

#### Save U_d and U_j medians and mads
```{r}
saveRDS(u_d, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "01_ud.rds")
        )

saveRDS(u_j, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "02_uj.rds")
        )
```

```{r}
u_d = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                          "01_ud.rds")
        )

u_j = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                          "02_uj.rds")
        )
```

### Counterfactual Analysis
#### Base model with estiamted U_d and U_j
```{r}
data_base = data_counter
```

```{r}
model_base = model_counter(data = data_base,
                           u_d = u_d, 
                           u_j = u_j, 
                           iter = 2000, 
                           chains = 4, 
                           seed = 2394875)

pred_base = prediction_counter(params_df = model_base$params,  
                               data = data_base, 
                               seed = 32458973,
                               color_nr = 2, 
                               plot_text = "originale Daten", 
                               plot_text_bin = "Original", 
                               plot_org_logit = NULL, 
                               plot_org_bin = NULL)
```

#### Interventions
##### Intervention on Sex: Males are Female, Females are Male now
```{r}
data_sex = data_counter %>% 
  mutate(Sex_Male = ifelse(Sex_Male == 1, 0, 1),
         Sex_Female = ifelse(Sex_Female == 1, 0, 1))
```

```{r}
model_sex = model_counter(data = data_sex,
                          u_d = u_d, 
                          u_j = u_j, 
                          iter = 2000, 
                          chains = 4, 
                          seed = 6832453)

pred_sex = prediction_counter(params_df = model_sex$params, 
                              data = data_sex, 
                              seed = 89358379,
                              color_nr = 3,
                              ymin_age_weight = -1,
                              ymax_age_weight = 1,
                              plot_text = "Geschlecht: Männlich \u2194 Weiblich", 
                              plot_text_bin = "Männlich \u2194 Weiblich", 
                              plot_org_logit = pred_base$plot_counter_logit, 
                              plot_org_bin = pred_base$plot_counter_bin)
```


##### Intervention on Race: Whites are Blacks, Blacks are Whites now, the other races stay the same

```{r}
data_race_wb = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_African_American == 1, 1, 0),
         Race_African_American_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_African_American)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_African_American = Race_African_American_new) %>% 
  relocate(c(Race_Caucasian, Race_African_American), .before = Race_Hispanic)
```

```{r}
model_race_wb = model_counter(data = data_race_wb,
                              u_d = u_d, 
                              u_j = u_j, 
                              iter = 2000,
                              chains = 4, 
                              seed = 98324757)

pred_race_wb = prediction_counter(params_df = model_race_wb$params, 
                                  data = data_race_wb, 
                                  color_nr = 1, 
                                  seed = 49586783,
                                  plot_text = "Race: Weiß \u2194 Schwarz", 
                                  plot_text_bin = "Weiß \u2194 Schwarz", 
                                  plot_org_logit = pred_base$plot_counter_logit, 
                                  plot_org_bin = pred_base$plot_counter_bin)
```


##### Intervention on Race: Whites are Hispanics, Hispanics are Whites now, the other races stay the same

```{r}
data_race_wh = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_Hispanic == 1, 1, 0),
         Race_Hispanic_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_Hispanic)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_Hispanic = Race_Hispanic_new) %>% 
  relocate(Race_Caucasian, .before = Race_African_American) %>% 
  relocate(Race_Hispanic, .after = Race_African_American) 
```

```{r}
model_race_wh = model_counter(data = data_race_wh,
                              u_d = u_d, 
                              u_j = u_j, 
                              iter = 2000,
                              chains = 4, 
                              seed = 23498573)

pred_race_wh = prediction_counter(params_df = model_race_wh$params, 
                                  data = data_race_wh, 
                                  color_nr = 4, 
                                  seed = 28975065,
                                  plot_text = "Race: Weiß \u2194 Hispanisch", 
                                  plot_text_bin = "Weiß \u2194 Hispanisch", 
                                  plot_org_logit = pred_base$plot_counter_logit, 
                                  plot_org_bin = pred_base$plot_counter_bin)
```


##### Intervention on Race: Whites are Others, Others are Whites now, the other races stay the same

```{r}
data_race_wo = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_Other == 1, 1, 0),
         Race_Other_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_Other)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_Other = Race_Other_new) %>% 
  relocate(Race_Caucasian, .before = Race_African_American) %>% 
  relocate(Race_Other, .after = Race_Hispanic) 
```

```{r}
model_race_wo = model_counter(data = data_race_wo,
                              u_d = u_d, 
                              u_j = u_j, 
                              iter = 2000,
                              chains = 4, 
                              seed = 94858385)

pred_race_wo = prediction_counter(params_df = model_race_wo$params, 
                                  data = data_race_wo, 
                                  color_nr = 5, 
                                  seed = 455927483,
                                  plot_text = "Race: Weiß \u2194 Andere", 
                                  plot_text_bin = "Weiß \u2194 Andere", 
                                  plot_org_logit = pred_base$plot_counter_logit, 
                                  plot_org_bin = pred_base$plot_counter_bin)
```

### Save Models
```{r}
saveRDS(model_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "03_model_base.rds")
        )

saveRDS(pred_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "04_pred_base.rds")
        )

saveRDS(model_sex, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "05_model_sex.rds")
        )

saveRDS(pred_sex, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "06_pred_sex.rds")
        )

saveRDS(model_race_wb, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "07_model_race_wb.rds")
        )

saveRDS(pred_race_wb, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "08_pred_race_wb.rds")
        )

saveRDS(model_race_wh, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "09_model_race_wh.rds")
        )

saveRDS(pred_race_wh, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "10_pred_race_wh.rds")
        )

saveRDS(model_race_wo, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "11_model_race_wo.rds")
        )

saveRDS(pred_race_wo, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "12_pred_race_wo.rds")
        )
```


### Reload Data & Models
```{r}
data_base = data_counter

data_sex = data_counter %>% 
  mutate(Sex_Male = ifelse(Sex_Male == 1, 0, 1),
         Sex_Female = ifelse(Sex_Female == 1, 0, 1))

data_race_wb = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_African_American == 1, 1, 0),
         Race_African_American_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_African_American)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_African_American = Race_African_American_new) %>% 
  relocate(c(Race_Caucasian, Race_African_American), .before = Race_Hispanic)

data_race_wh = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_Hispanic == 1, 1, 0),
         Race_Hispanic_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_Hispanic)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_Hispanic = Race_Hispanic_new) %>% 
  relocate(Race_Caucasian, .before = Race_African_American) %>% 
  relocate(Race_Hispanic, .after = Race_African_American) 

data_race_wo = data_counter %>% 
  mutate(Race_Caucasian_new = ifelse(Race_Other == 1, 1, 0),
         Race_Other_new = ifelse(Race_Caucasian == 1, 1, 0)) %>% 
  select(!c(Race_Caucasian, Race_Other)) %>% 
  rename(Race_Caucasian = Race_Caucasian_new,
         Race_Other = Race_Other_new) %>% 
  relocate(Race_Caucasian, .before = Race_African_American) %>% 
  relocate(Race_Other, .after = Race_Hispanic) 
```

```{r}
model_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "03_model_base.rds")
                    )

pred_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                "04_pred_base.rds")
                   )

model_sex = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "05_model_sex.rds")
                  )

pred_sex = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                               "06_pred_sex.rds")
                  )

model_race_wb = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                    "07_model_race_wb.rds")
                       )

pred_race_wb = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                   "08_pred_race_wb.rds")
                      )

model_race_wh = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                    "09_model_race_wh.rds")
                       )

pred_race_wh = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                   "10_pred_race_wh.rds")
                      )

model_race_wo = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                    "11_model_race_wo.rds")
                       )

pred_race_wo = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                   "12_pred_race_wo.rds")
                      )
```

### Comparison plots
#### Logits
```{r}
# Colors
bin_colors_sex = unique(ggplot_build(pred_sex$plot_comp_bin)$data[[1]]["fill"])

bin_colors_race_wb = unique(ggplot_build(pred_race_wb$plot_comp_bin)$data[[1]]["fill"])

bin_colors_race_wh = unique(ggplot_build(pred_race_wh$plot_comp_bin)$data[[1]]["fill"])

bin_colors_race_wo = unique(ggplot_build(pred_race_wo$plot_comp_bin)$data[[1]]["fill"])

# Sex
plot_sex_logit = pred_sex$plot_comp_logit +
   geom_label(x = 0.55, y = 1.25, label = "Original", color = bin_colors_sex[1,1]) +
   geom_label(x = 0.2, y = 1.2, label = "Kontrafaktisch", color = bin_colors_sex[2,1]) 

# Race
plot_race_wb_logit = pred_race_wb$plot_comp_logit +
   geom_label(x = 0.55, y = 1.25, label = "Original", color = bin_colors_race_wb[1,1]) +
   geom_label(x = 0.2, y = 1.15, label = "Kontrafaktisch", color = bin_colors_race_wb[2,1]) 

plot_race_wh_logit = pred_race_wh$plot_comp_logit +
   geom_label(x = 0.55, y = 1.3, label = "Original", color = bin_colors_race_wh[1,1]) +
   geom_label(x = 0.1, y = 1.1, label = "Kontrafaktisch", color = bin_colors_race_wh[2,1]) 

plot_race_wo_logit = pred_race_wo$plot_comp_logit +
   geom_label(x = 0.55, y = 1.23, label = "Original", color = bin_colors_race_wo[1,1]) +
   geom_label(x = 0.15, y = 1.1, label = "Kontrafaktisch", color = bin_colors_race_wo[2,1]) 
```


#### Binary Outcomes
```{r}
plot_sex_bin = pred_sex$plot_comp_bin +
          labs(title = "Vergleich der geschätzten Werte für den COMPAS-Score",
             subtitle = "Häufigkeit der geschätzten Score-Werte für originale & kontrafaktische Daten (Geschlecht)",
             x = "COMPAS-Score",
             y = "Geschätzte Häufigkeit",
             fill = "Daten") +
          scale_fill_manual(values = as.vector(bin_colors_sex[,1]))

pred_race_bin = pred_race_wb

pred_race_bin = prediction_counter(params_df = model_race_wh$params, 
                                  data = data_race_wh, 
                                  color_nr = 4, 
                                  seed = 28975065,
                                  plot_text = "Race: Weiß \u2194 Hispanisch", 
                                  plot_text_bin = "Weiß \u2194 Hispanisch", 
                                  plot_org_logit = pred_race_bin$plot_comp_logit, 
                                  plot_org_bin = pred_race_bin$plot_comp_bin)

pred_race_bin = prediction_counter(params_df = model_race_wo$params, 
                                  data = data_race_wo, 
                                  color_nr = 5, 
                                  seed = 455927483,
                                  plot_text = "Race: Weiß \u2194 Andere", 
                                  plot_text_bin = "Weiß \u2194 Andere",
                                  plot_org_logit = pred_race_bin$plot_comp_logit, 
                                  plot_org_bin = pred_race_bin$plot_comp_bin)

plot_race_bin = pred_race_bin$plot_comp_bin +
        labs(title = "Vergleich der geschätzten Werte für den COMPAS-Score",
             subtitle = "Häufigkeit der geschätzten Score-Werte für originale & kontrafaktische Daten (Race)",
             x = "COMPAS-Score",
             y = "Geschätzte Häufigkeit",
             fill = "Daten")
```


### Weight comparison
```{r}
# Sex
weights_sex_base = pred_base$weight_table %>% 
  select(starts_with("compas_Sex")) %>% 
  rename(Original_Männlich = "compas_Sex: Male",
         Original_Weiblich = "compas_Sex: Female") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Geschlecht"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "mad", "mad"))

weights_sex_counter = pred_sex$weight_table %>% 
  select(starts_with("compas_Sex")) %>% 
  rename("Männlich \u2194 Weiblich_Männlich" = "compas_Sex: Male",
         "Männlich \u2194 Weiblich_Weiblich" = "compas_Sex: Female") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Geschlecht"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "mad", "mad"))

plot_weights_sex = rbind(weights_sex_base, weights_sex_counter) %>% 
  pivot_wider(names_from = "value_type",
              values_from = "value") %>% 
  mutate(Geschlecht = factor(Geschlecht, levels = c("Weiblich", "Männlich"))) %>% 
  mutate(ymin = median - (1/2)*mad,
         ymax = median + (1/2)*mad) %>% 
  ggplot(aes(x = Geschlecht, y = median, color = Geschlecht)) +
  geom_abline(intercept = 0, slope = 0, linewidth = 0.2) +
  geom_point(size = 2) +
  geom_errorbar(aes(x = Geschlecht, ymin = ymin, ymax = ymax), width = 0.3) +
  facet_wrap(~ factor(Modell, levels = c("Original", 
                                         "Männlich \u2194 Weiblich")
                      ), 
             dir = "v") +
  labs(title = "Median & MAD der Regressions-Gewichte für COMPAS-Score-Gleichung",
       subtitle = "für originale & kontrafaktische Daten (Geschlecht)",
       y =  "Median \u00b1 MAD") +
  guides(color = "none") +
  scale_color_manual(values = colors_discrete[c(3,2)]) +
  coord_flip()

# Race
weights_race_base = pred_base$weight_table %>% 
  select(starts_with("compas_Race")) %>% 
  rename(Original_Weiß = "compas_Race: Caucasian",
         Original_Schwarz = "compas_Race: African-American",
         Original_Hispanisch = "compas_Race: Hispanic",
         Original_Andere = "compas_Race: Other") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Race"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "median", "median", 
                        "mad", "mad", "mad", "mad"))

weights_race_wb = pred_race_wb$weight_table %>% 
  select(starts_with("compas_Race")) %>% 
  rename("Weiß \u2194 Schwarz_Weiß" = "compas_Race: Caucasian",
         "Weiß \u2194 Schwarz_Schwarz" = "compas_Race: African-American",
         "Weiß \u2194 Schwarz_Hispanisch" = "compas_Race: Hispanic",
         "Weiß \u2194 Schwarz_Andere" = "compas_Race: Other") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Race"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "median", "median", 
                        "mad", "mad", "mad", "mad"))

weights_race_wh = pred_race_wh$weight_table %>% 
  select(starts_with("compas_Race")) %>% 
  rename("Weiß \u2194 Hispanisch_Weiß" = "compas_Race: Caucasian",
         "Weiß \u2194 Hispanisch_Schwarz" = "compas_Race: African-American",
         "Weiß \u2194 Hispanisch_Hispanisch" = "compas_Race: Hispanic",
         "Weiß \u2194 Hispanisch_Andere" = "compas_Race: Other") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Race"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "median", "median", 
                        "mad", "mad", "mad", "mad"))

weights_race_wo = pred_race_wo$weight_table %>% 
  select(starts_with("compas_Race")) %>% 
  rename("Weiß \u2194 Andere_Weiß" = "compas_Race: Caucasian",
         "Weiß \u2194 Andere_Schwarz" = "compas_Race: African-American",
         "Weiß \u2194 Andere_Hispanisch" = "compas_Race: Hispanic",
         "Weiß \u2194 Andere_Andere" = "compas_Race: Other") %>% 
  pivot_longer(cols = everything(),
               names_to = c("Modell", "Race"),
               names_sep = "_") %>% 
  mutate(value_type = c("median", "median", "median", "median", 
                        "mad", "mad", "mad", "mad"))

plot_weights_race = rbind(weights_race_base, 
                          weights_race_wb,
                          weights_race_wh,
                          weights_race_wo) %>% 
  pivot_wider(names_from = "value_type",
              values_from = "value") %>% 
  mutate(ymin = median - (1/2)*mad,
         ymax = median + (1/2)*mad) %>% 
  ggplot(aes(x = Race, y = median, color = Race)) +
  geom_abline(intercept = 0, slope = 0, linewidth = 0.2) +
  geom_point(size = 0.8) +
  geom_errorbar(aes(x = Race, ymin = ymin, ymax = ymax), width = 0.8, linewidth = 0.3) +
  facet_wrap(~ factor(Modell, levels = c("Original",
                                         "Weiß \u2194 Schwarz",
                                         "Weiß \u2194 Hispanisch",
                                         "Weiß \u2194 Andere")
                      ), 
             nrow = 4, ncol = 1) +
  labs(title = "Median & MAD der Regressions-Gewichte für COMPAS-Score-Gleichung",
       subtitle = "für originale & kontrafaktische Daten (Race)",
       y =  "Median \u00b1 MAD") +
  guides(color = "none") +
  scale_color_manual(values = colors_discrete[c(5,4,1,2)]) +
  coord_flip()

plot_weights_race
```

### Save graphs
```{r}
ggsave("02_plot_sex_logit.png",
       plot = plot_sex_logit,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("03_plot_race_wb_logit.png",
       plot = plot_race_wb_logit,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("04_plot_race_wh_logit.png",
       plot = plot_race_wh_logit,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("05_plot_race_wo_logit.png",
       plot = plot_race_wo_logit,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("06_plot_sex_bin.png",
       plot = plot_sex_bin,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("07_plot_race_bin.png",
       plot = plot_race_bin,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("08_plot_weights_sex.png",
       plot = plot_weights_sex,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("09_plot_weights_race.png",
       plot = plot_weights_race,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )
```

### Epsilon-delta-approximate counterfactual fairness
#### Sex
```{r}
delta_sex = approx_counterfairness(base_outcome = pred_base$counter_pred,
                                   counter_outcome = pred_sex$counter_pred,
                                   epsilon = 0.1)

delta_sex
```

#### Race
```{r}
delta_wb = approx_counterfairness(base_outcome = pred_base$counter_pred,
                                  counter_outcome = pred_race_wb$counter_pred,
                                  epsilon = 0.1)

delta_wh = approx_counterfairness(base_outcome = pred_base$counter_pred,
                                  counter_outcome = pred_race_wh$counter_pred,
                                  epsilon = 0.1)

delta_wo = approx_counterfairness(base_outcome = pred_base$counter_pred,
                                  counter_outcome = pred_race_wo$counter_pred,
                                  epsilon = 0.1)

delta_race = max(delta_wb, delta_wh, delta_wo)
delta_race
```

## Post-Processing: ROC-Pivot
### Calculate theta for Sex
```{r}
theta_sex = theta_calc(theta_lower = 0,
                       theta_upper = 0.05,
                       step = 0.001,
                       epsilon = 0.1,
                       data_base = data_base,
                       logit_base = pred_base$counter_pred_logit,
                       data_counter = list(data_sex),
                       logit_counter = list(pred_sex$counter_pred_logit),
                       prot = "Sex",
                       priv = "Sex_Male")

theta_sex
```


### Calculate theta for Race
```{r}
theta_race = theta_calc(theta_lower = 0,
                        theta_upper = 0.005,
                        step = 0.0001,
                        epsilon = 0.1,
                        data_base = data_base,
                        logit_base = pred_base$counter_pred_logit,
                        data_counter = list(data_race_wb, 
                                            data_race_wh, 
                                            data_race_wo),
                        logit_counter = list(pred_race_wb$counter_pred_logit,
                                             pred_race_wh$counter_pred_logit,
                                             pred_race_wo$counter_pred_logit),
                        prot = "Race",
                        priv = "Race_Caucasian")

theta_race
```

### Plots for Deltas
Sex
```{r}
plot_theta_sex_base = data.frame(x = c("Original"),
                            y = c(delta_sex)) %>% 
  ggplot(aes(x = x, y = y, fill = x)) +
  geom_col() +
  geom_text(aes(label = round(y, 4)), 
              vjust = -0.35) +
  labs(title = "Vergleich der (\u03B5-\u03B4)-approximativen kontrafaktischen Fairness für Geschlecht",
       subtitle = "für Original-Modell (mit fixem \u03B5=0.1)",
       x = "Modell",
       y = "\u03B4 (Delta)") +
  scale_fill_manual(values = wes_palette("Darjeeling1")[c(5,3)]) +
    scale_x_discrete(expand = c(0, 1.2)) +
  lims(y = c(0,0.5)) +
  guides(fill = "none")

plot_theta_sex_base
```

```{r}
plot_theta_sex = data.frame(x = c("Original", paste0("Post-processed (\u03B8 = ", theta_sex$theta, ")")),
                            y = c(delta_sex, theta_sex$delta)) %>% 
  ggplot(aes(x = x, y = y, fill = x)) +
  geom_col() +
  geom_text(aes(label = round(y, 4)), 
              vjust = -0.35) +
  labs(title = "Vergleich der (\u03B5-\u03B4)-approximativen kontrafaktischen Fairness für Geschlecht",
       subtitle = "für Original- & Post-processed-Modell (mit fixem \u03B5=0.1)",
       x = "Modell",
       y = "\u03B4 (Delta)") +
  scale_fill_manual(values = wes_palette("Darjeeling1")[c(5,3)]) +
  scale_x_discrete(expand = c(0, 0.8)) +
  lims(y = c(0,0.5)) +
  guides(fill = "none")

plot_theta_sex
```

Race

```{r}
plot_theta_race_base = data.frame(x = c("Original"),
                            y = c(delta_race)) %>% 
  ggplot(aes(x = x, y = y, fill = x)) +
  geom_col() +
  geom_text(aes(label = round(y, 4)), 
              vjust = -0.35) +
  labs(title = "Vergleich der (\u03B5-\u03B4)-approximativen kontrafaktischen Fairness für Race",
       subtitle = "für Original-Modell (mit fixem \u03B5=0.1)",
       x = "Modell",
       y = "\u03B4 (Delta)") +
  scale_fill_manual(values = wes_palette("Darjeeling1")[c(5,3)]) +
  scale_x_discrete(expand = c(0, 1.2)) +
  lims(y = c(0,0.5)) +
  guides(fill = "none")

plot_theta_race_base
```

```{r}
plot_theta_race = data.frame(x = c("Original", paste0("Post-processed (\u03B8 = ", theta_race$theta, ")")),
                            y = c(delta_race, theta_race$delta)) %>% 
  ggplot(aes(x = x, y = y, fill = x)) +
  geom_col() +
  geom_text(aes(label = round(y, 4)), 
              vjust = -0.35) +
  labs(title = "Vergleich der (\u03B5-\u03B4)-approximativen kontrafaktischen Fairness für Race",
       subtitle = "für Original- & Post-processed-Modell (mit fixem \u03B5=0.1)",
       x = "Modell",
       y = "\u03B4 (Delta)") +
  scale_fill_manual(values = wes_palette("Darjeeling1")[c(5,3)]) +
  scale_x_discrete(expand = c(0, 0.8)) +
  lims(y = c(0,0.5)) +
  guides(fill = "none")

plot_theta_race
```

```{r}
ggsave("10_plot_theta_sex_base.png",
       plot = plot_theta_sex_base,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("11_plot_theta_sex.png",
       plot = plot_theta_sex,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("12_plot_theta_race_base.png",
       plot = plot_theta_race_base,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )

ggsave("13_plot_theta_race.png",
       plot = plot_theta_race,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 20,
       height = 12,
       units = c("cm")
       )
```

