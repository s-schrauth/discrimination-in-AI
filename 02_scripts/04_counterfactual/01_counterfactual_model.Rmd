---
title: "Counterfactual Fairness Model"
author: "Simon Schrauth"
date: "`r Sys.Date()`"
output: html_document
---

# Counterfactual Fairness

## Goal

After executing this script, the counterfactual fairness/discrimination of the base model should be determined.

## Preparation
### Install packages

Installing rstan package (and the dependent StanHeaders package) from source (for additional information or in the case of installation problems see also <https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started>)

```{r}
install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```

```{r}
pacman::p_load(tidyverse, 
               here,
               fastDummies,
               dagitty,
               ggdag,
               rstan,
               wesanderson,
               ggdist,
               ggformula)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

### Load data

```{r}
data_train = readRDS(here("01_data", "02_data_processed", "01_base_model",
                          "04_data_train.rds"))
```

### Prepare data

```{r}
data_counter = data_train %>% 
  select(Age = age,
         Sex = sex,
         Race = race,
         JuvFel = juv_fel_count,
         JuvMisd = juv_misd_count,
         Priors = priors_count,
         Crime = charge_degree,
         COMPAS = compas) %>% 
  dummy_cols(select_columns = c("Race", "Sex"),
             remove_first_dummy = FALSE,
             remove_selected_columns = TRUE) %>% 
  rename("Race_Native_American" = "Race_Native American",
         "Race_African_American" = "Race_African-American") %>% 
  mutate(Crime = ifelse(Crime == "F", 1, 0),
         COMPAS = ifelse(COMPAS == "High", 1, 0)) 

colors = wes_palette("Darjeeling1")
colors_discrete = rep(wes_palette("Darjeeling1"), 3)
```

## Build DAG (directed acyclic graph)

```{r}
dag = dagitty('dag {
  Age [exposure,pos="0,-2"]
  Sex [pos="0,-1"]
  Race [pos="0,0"]
  Priors [pos="0.5, -1.75"]
  Crime [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JuvMisd [pos="0.5, -0.25"]
  JuvFel [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  
  Race -> Priors
  Race -> Crime
  Race -> JuvMisd
  Race -> JuvFel
  Race -> COMPAS
  Sex -> Priors
  Sex -> Crime
  Sex -> JuvMisd
  Sex -> JuvFel
  Sex -> COMPAS
  Age -> Priors
  Age -> Crime
  Age -> JuvMisd
  Age -> JuvFel
  Age -> COMPAS
  U_D -> Priors
  U_D -> Crime
  U_J -> JuvMisd
  U_J -> JuvFel
  U_D -> COMPAS
  }')

#tidy_dagitty(dag)

dag_plot = tidy_dagitty(dag) %>% 
  mutate(name = str_replace(name, "U_J", "U[J]")) %>% 
  mutate(name = str_replace(name, "U_D", "U[D]")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == "COMPAS"),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]"),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to != "COMPAS"),
                          curvature = 1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Sex", "Age")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name=="COMPAS"),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Priors", 
                                                         "Crime",
                                                         "JuvMisd",
                                                         "JuvFel")),
                color = colors[4]) +
  geom_dag_text(size = 2.2, parse = TRUE) +
  theme_dag()

dag_plot

```

```{r}
ggsave("01_dag.png",
       plot = dag_plot,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```

## Build Structural Causal Model via Bayesian Estimation

## with RStan (adapted code from <https://github.com/mkusner/counterfactual-fairness>)

### Base model (for estimating U_d and U_j)

#### Prepare data for base model

```{r}
data_base_protected = data_counter %>% 
  select(starts_with(c("Race_", "Sex_"))) 

n = nrow(data_counter)


data_base_list = list(N = n,
                         K = length(data_base_protected),
                         prot = data.matrix(data_base_protected),
                         age = data_counter[, "Age", drop = TRUE],
                         priors = data_counter[, "Priors", drop = TRUE],
                         crime = data_counter[, "Crime", drop = TRUE],
                         juvmisd = data_counter[, "JuvMisd", drop = TRUE],
                         juvfel = data_counter[, "JuvFel", drop = TRUE],
                         compas = data_counter[, "COMPAS", drop = TRUE])
```

#### Fit base model

```{r}
fit_base = stan(file = here("02_scripts", "04_counterfactual",
                            "02_counterfactual_model_base.stan"), 
                data = data_base_list, 
                iter = 2000, 
                chains = 4,
                seed = 219684725,
                verbose = TRUE)

params_base = extract(fit_base)
```

#### Save base model

```{r}
saveRDS(fit_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                    "01_model_base_fit.rds")
        )

saveRDS(params_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                    "02_model_base_params.rds")
        )

fit_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                               "01_model_base_fit.rds")
        )

params_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", "big_data",
                                  "02_model_base_params.rds")
        )
```

#### Have a look at sampled U_d parameter distributions

```{r}
s = sample(seq(1,5553), 10)

pc = as.data.frame(params_base)[,s] %>% 
  pivot_longer(cols = everything())

pc %>% 
  ggplot(aes(x = name, y = value, fill = name)) +
  ggdist::stat_halfeye(
    adjust = 0.75,
    justification = -.05,
    .width = 0,
    point_colour = NA
     ) +
  guides(fill = "none") +
  coord_flip() 
```

#### Compute median and median absolute deviaten (mad) of U_d and U_j distributions for all cases

```{r}
u_d = params_base %>% 
  as.data.frame() %>% 
  select(starts_with(c("u_d"))) %>% 
  summarise(across(.cols = everything(),
                   .fns = list(median = median, mad = mad),
                   .names = "{.col}-{.fn}"))  %>% 
  pivot_longer(cols = everything(),
               names_to = c("case", "metric"),
               names_sep = "-") %>% 
  mutate(case = as.numeric(str_replace(case, "u_d.(\\d*)", "\\1"))) %>% 
  pivot_wider(names_from = "metric",
              values_from = "value")

u_j = params_base %>% 
  as.data.frame() %>% 
  select(starts_with(c("u_j"))) %>% 
  summarise(across(.cols = everything(),
                   .fns = list(median = median, mad = mad),
                   .names = "{.col}-{.fn}")) %>% 
  pivot_longer(cols = everything(),
               names_to = c("case", "metric"),
               names_sep = "-") %>% 
  mutate(case = as.numeric(str_replace(case, "u_j.(\\d*)", "\\1"))) %>% 
  pivot_wider(names_from = "metric",
              values_from = "value")
```

#### Save U_d and U_j medians and mads

```{r}
saveRDS(u_d, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "01_ud.rds")
        )

saveRDS(u_j, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "02_uj.rds")
        )

u_d = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                          "01_ud.rds")
        )

u_j = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                          "02_uj.rds")
        )
```

### Counterfactual Analysis

#### Function definitions

Function for modelling

```{r}
model_counter = function(data, 
                         u_d = u_d, 
                         u_j = u_j, 
                         iter = 2000, 
                         chains = 4, 
                         seed = 34568979){
  
  # Define protected variables
  data_prot = data %>% 
    select(starts_with(c("Race_", "Sex_"))) 
  
  n = nrow(data)

  # Create list for Stan file
  data_list= list(N = n,
                  K = length(data_prot),
                  prot = data.matrix(data_prot),
                  age = data[, "Age", drop = TRUE],
                  priors = data[, "Priors", drop = TRUE],
                  crime = data[, "Crime", drop = TRUE],
                  juvmisd = data[, "JuvMisd", drop = TRUE],
                  juvfel = data[, "JuvFel", drop = TRUE],
                  compas = data[, "COMPAS", drop = TRUE],
                  mu_d = u_d[, "median", drop = TRUE],
                  sigma_d = u_d[, "mad", drop = TRUE],
                  mu_j = u_j[, "median", drop = TRUE],
                  sigma_j = u_j[, "mad", drop = TRUE])
  
  # Calculate model with Stan
  fit = stan(file = here("02_scripts", "04_counterfactual",
                         "03_counterfactual_model_general.stan"), 
             data = data_list, 
             iter = iter,
             chains = chains,
             seed = seed,
             verbose = TRUE)
  
  # Extract model parameter/weight distribution
  params = extract(fit)
  
  output = list(fit = fit,
                params = params)
  
  return(output)
}
```

Functions for Weight Plotting

```{r}
# Function for correct naming of protected variables
  param_names = function(col){
  
    pattern = c("_prot.1", 
                "_prot.2",
                "_prot.3",
                "_prot.4",
                "_prot.5",
                "_prot.6",
                "_prot.7",
                "_prot.8")
    
    replacement = c("_Race: Caucasian",
                    "_Race: African-American",
                    "_Race: Asian",
                    "_Race: Hispanic",
                    "_Race: Native-American",
                    "_Race: Other",
                    "_Sex: Male",
                    "_Sex: Female")
    
    for (i in 1:length(pattern)){
      col = str_replace(col, pattern[i], replacement[i])
    }
    
    return(col)
  }

# Function for plot of compas weights (except age variable)
plot_compas_weights = function(data, plot_text){
  
  colors_discrete = rep(wes_palette("Darjeeling1"), 3)
  
  plot = data %>% 
     as.data.frame() %>% 
     select(starts_with("compas"),
            -c("compas_age")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ param_names(.x)) %>%
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "compas_", "")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "bias", "Bias")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "ud", "Ud")) %>%   
     pivot_longer(cols = everything()) %>%
     ggplot(aes(x = name, y = value, fill = name)) +
        ggdist::stat_halfeye(
          adjust = 0.75,
          justification = -.05,
          .width = 0,
          point_colour = NA
        ) +
        geom_boxplot(
          width = .12,
          outlier.colour = NA,
          alpha = 0.5
        ) +
        geom_abline(intercept = 0, slope = 0) +
        scale_fill_manual(values = colors_discrete) +
        guides(fill = "none") +
        labs(title = "Posterior Distribution of Model Weights",
             subtitle = paste0("Only Weights for COMPAS Equation (without Age) for ", plot_text),
             y = "Weight Value",
             x = "Weight for COMPAS Prediction") +
        coord_flip() 
  
  return(plot)
}

# Function for plot of compas weights (only age variable)
plot_compas_weights_age = function(data, plot_text, ymin = -0.5, ymax = 0){
  
  colors_discrete = rep(wes_palette("Darjeeling1"), 3)
  
  plot = data %>% 
     as.data.frame() %>% 
     select(c("compas_age")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "compas_age", "Age")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ param_names(.x)) %>%
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "compas_", "")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "bias", "Bias")) %>% 
     rename_with(.cols = everything(), 
                 .fn = ~ str_replace(.x, "ud", "Ud")) %>%   
     pivot_longer(cols = everything()) %>%
     ggplot(aes(x = name, y = value, fill = name)) +
        ggdist::stat_halfeye(
          adjust = 0.75,
          justification = -.05,
          .width = 0,
          point_colour = NA
        ) +
        geom_boxplot(
          width = .12,
          outlier.colour = NA,
          alpha = 0.5
        ) +
        geom_abline(intercept = 0, slope = 0) +
        scale_fill_manual(values = colors_discrete) +
        guides(fill = "none") +
        ylim(ymin, ymax) +
        labs(title = "Posterior Distribution of Model Weights",
             subtitle = paste0("Only Weights for COMPAS Equation (only Age) for ", plot_text),
             y = "Weight Value",
             x = "Weight for COMPAS Prediction") +
        coord_flip() 
  
  return(plot)
}

# Function for table of the median and mad of all weights
weight_table = function(data){
  data %>% 
    as.data.frame() %>% 
    select(-starts_with("u_d"), 
           -starts_with("u_j"), 
           -lp__) %>% 
    rename_with(.cols = everything(), 
                .fn = ~ param_names(.x)) %>% 
    summarise(across(everything(),
                     list(median = median,
                          mad = mad))) %>% 
    round(digits = 2) %>% 
    pivot_longer(cols = everything(),
                 names_to = c("variable",
                              "metric"),
                 names_pattern = "(.*)_([a-z]*)$") %>% 
    pivot_wider(names_from = "variable") %>% 
    column_to_rownames(var = "metric")
}
```

Functions for Prediction & Plotting (adapted code from [https://medium.com/\@alex.pavlakis/making-predictions-from-stan-models-in-r-3e349dfac1ed](https://medium.com/@alex.pavlakis/making-predictions-from-stan-models-in-r-3e349dfac1ed){.uri})

```{r}
# Function for prediction of logit values of given data frame
prediction_counter_logit = function(data, params_df, fun, seed){
  
  set.seed((seed))
  
  # Only U_d, U_j and compas weights are relevant
  params_df_new = params_df %>% 
    select(starts_with(c("u_", "compas_")))
  
  # Sample a parameter set for each observation
  params = data.frame(matrix(NA, nrow = nrow(data), ncol = ncol(params_df_new)))
  colnames(params) = colnames(params_df_new)
  
  for (i in 1:ncol(params)) {
    params[,i] = sample(params_df_new[,i], size = nrow(params), replace = TRUE)
  }
  
  # Define certain parameter and variable data frames
  param_prot = params %>% 
    select(starts_with("compas_prot"))
  
  data_prot = data %>% 
    select(starts_with(c("Race_", "Sex_"))) %>% 
    as.matrix()
  
  data_ud = params %>% 
    select(starts_with("u_d")) %>% 
    as.matrix() %>% 
    t()
  
  # Create empty matrix for results
  inv_logit_raw = matrix(NA,
                         nrow = nrow(data),
                         ncol = ncol(data_ud)) 
  
  # Loop over all possible U_d values (4000 per observation)
  for (i in 1:ncol(data_ud)) {
    
      # Calculate linear combination for COMPAS equation for all observations
      lin_comb = params$compas_bias + 
                 params$compas_age * data$Age + 
                 rowSums(param_prot * data_prot) +
                 as.vector(params$compas_ud * data_ud[,i])
  
      # Calculate logit for all observations
      inv_logit_raw[,i] = 1/(1 + exp(-lin_comb))
  }

  # Summarise logits over all possible U_d values with function "fun" (e.g. median)
  inv_logit = apply(inv_logit_raw, 1, fun)
  
  return(inv_logit)
}
```

```{r}
# Function for prediction dataframes and prediction plots (incl. weights) 
prediction_counter = function(params_df, 
                              data, 
                              threshold = 0.5, 
                              seed = 3928567, 
                              ymin_age_weight = -0.5,
                              ymax_age_weight = 0,
                              color_nr,
                              plot_text,
                              plot_text_bin,
                              plot_org_logit = NULL,
                              plot_org_bin = NULL){
  
  # Calculate predicted values for logits and COMPAS score
  counter_pred_logit = prediction_counter_logit(params_df = params_df %>% as.data.frame(),
                                                data = data,
                                                fun = "median",
                                                seed = seed)
  
  counter_pred = ifelse(counter_pred_logit >= threshold, 1, 0)
  
  # Calculate accuracy of prediction
  accuracy = mean((counter_pred == data$COMPAS))
  
  # Plots for weights
  plot_compas_weights = plot_compas_weights(data = params_df, 
                                            plot_text = plot_text)
  
  plot_compas_weights_age = plot_compas_weights_age(data = params_df, 
                                                    plot_text = plot_text, 
                                                    ymin = ymin_age_weight, 
                                                    ymax = ymax_age_weight)
  weight_table = weight_table(data = params_df)
  
  
  ## Plots for predictions
  colors = wes_palette("Darjeeling1")
  
  # Plot for predicted logits
  plot_counter_logit = counter_pred_logit %>% 
    as_tibble() %>% 
    rename(logit = value) %>% 
    ggplot(aes()) +
    geom_histogram(aes(x = logit, y = after_stat(density)), 
                   bins = 30, 
                   fill = colors[color_nr],
                   alpha = 0.3) +
    geom_density(aes(x = logit),
                 linewidth = 1,
                 color = colors[color_nr]) +
    labs(title = "Predicted Values for Probabilites of a High COMPAS Score",
         subtitle = paste0("Histogram and Density Function for ", plot_text),
         x = "Predicted Probability of a High COMPAS Score",
         y = "Density") 
  
  # Plot for predicted COMPAS score
  plot_counter_bin = counter_pred %>% 
    as_tibble() %>% 
    group_by(value) %>% 
    summarise(n = n()) %>% 
    mutate(value = factor(value, levels = c(0,1), labels = c("Low", "High"))) %>% 
    ggplot(aes(x = value, y = n)) +
    geom_col(fill = colors[color_nr]) +
    labs(title = "Predicted Values for COMPAS Score",
         subtitle = paste0("Absolute Frequency of Predicted Score Values for ", plot_text),
         x = "COMPAS Score",
         y = "Predicted Frequency") 
  
  ## Plots for comparison of model predictions and base model predictions
  plot_comp_logit = NULL
  plot_comp_bin = NULL
  
  # Plot for comparison of predicted logits in model and base model
  if(!is.null(plot_org_logit)){
    plot_comp_logit = plot_org_logit +
      geom_histogram(data = counter_pred_logit %>% as_tibble() %>% rename(logit = value) ,
                 aes(x = logit, y = after_stat(density)), 
                 bins = 30, 
                 fill = colors[color_nr],
                 alpha = 0.3) +
      geom_density(data = counter_pred_logit %>% as_tibble() %>% rename(logit = value), 
                   aes(x = logit),
                   linewidth = 1,
                   color = colors[color_nr]) +
      labs(title = "Comparison of Predicted Values for Probabilites of a High COMPAS Score",
           subtitle = paste0("Histogram and Density Function for Original Data & Intervention Data"),
           x = "Predicted Probability of a High COMPAS Score",
           y = "Density") 
  }
  
  # Plot for comparison of predicted COMPAS scores in model and base model
  if(!is.null(plot_org_bin)){
    
    counter_pred_plot = counter_pred %>% 
      as_tibble() %>% 
      group_by(value) %>% 
      summarise(n = n()) %>% 
      mutate(value = factor(value, levels = c(0,1), labels = c("Low", "High")),
             Data = factor(plot_text_bin))
    
    if(ncol(plot_org_bin$data) == 2){
       plot_comp_bin = plot_org_bin$data %>% 
        mutate(Data = factor("Original")) %>% 
        rbind(counter_pred_plot) %>% 
        group_by(Data) %>% 
        ggplot(aes(x = value, y = n, fill = Data)) +
        geom_col(position = position_dodge(0.82), width = 0.8) +
        labs(title = "Comparison of Predicted Values for COMPAS Score",
             subtitle = paste0("Frequency of Predicted Score Values for Original Data & ", plot_text),
             x = "COMPAS Score",
             y = "Predicted Frequency") +
        scale_fill_manual(values = c(colors[2], colors[color_nr]))
    } else {
      plot_comp_bin = plot_org_bin$data %>% 
        rbind(counter_pred_plot) %>% 
        group_by(Data) %>% 
        ggplot(aes(x = value, y = n, fill = Data)) +
        geom_col(position = position_dodge(0.82), width = 0.8) +
        labs(title = "Comparison of Predicted Values for COMPAS Score",
             subtitle = paste0("Frequency of Predicted Score Values for Original Data & Intervention Data"),
             x = "COMPAS Score",
             y = "Predicted Frequency") +
        scale_fill_manual(values = c(as.vector(unique(ggplot_build(plot_org_bin)$data[[1]]["fill"])[["fill"]]),
                                     colors[color_nr]))
    }
  }
  
  # Output list
  output = list(counter_pred_logit = counter_pred_logit,
                counter_pred = counter_pred,
                accuracy = accuracy,
                plot_compas_weights = plot_compas_weights,
                plot_compas_weights_age = plot_compas_weights_age,
                weight_table = weight_table,
                plot_counter_logit = plot_counter_logit,
                plot_counter_bin = plot_counter_bin,
                plot_comp_logit = plot_comp_logit,
                plot_comp_bin = plot_comp_bin
                )
  
  return(output)
}
```


#### Base model with estiamted U_d and U_j

```{r}
data_base = data_counter

model_base = model_counter(data = data_base,
                           u_d = u_d, 
                           u_j = u_j, 
                           iter = 2000, 
                           chains = 4, 
                           seed = 2394875)

pred_base = prediction_counter(params_df = model_base$params,  
                               data = data_base, 
                               seed = 32458973,
                               color_nr = 2, 
                               plot_text = "Original Data", 
                               plot_text_bin = "Original", 
                               plot_org_logit = NULL, 
                               plot_org_bin = NULL)
```

```{r}
saveRDS(model_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "03_model_base.rds")
        )

saveRDS(pred_base, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "04_pred_base.rds")
        )

model_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "03_model_base.rds")
                    )

pred_base = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                "04_pred_base.rds")
                   )
```

#### Interventions

##### Intervention on Sex: all cases are now male

```{r}
data_sexm = data_counter %>% 
  mutate(Sex_Male = 1, 
         Sex_Female = 0)

model_sexm = model_counter(data = data_sexm,
                           u_d = u_d, 
                           u_j = u_j, 
                           iter = 2000, 
                           chains = 4, 
                           seed = 98324757)

pred_sexm = prediction_counter(params_df = model_sexm$params, 
                               data = data_sexm, 
                               seed = 1893475893,
                               color_nr = 3, 
                               plot_text = "Intervention Sex -> Male", 
                               plot_text_bin = "Male", 
                               plot_org_logit = pred_base$plot_counter_logit, 
                               plot_org_bin = pred_base$plot_counter_bin)
```

```{r}
saveRDS(model_sexm, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "05_model_sexm.rds")
        )

saveRDS(pred_sexm, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "06_pred_sexm.rds")
        )

model_sexm = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "05_model_sexm.rds")
                    )

pred_sexm = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "06_pred_sexm.rds")
                   )
```

##### Intervention on Sex: all cases are now female

```{r}
data_sexf = data_counter %>% 
  mutate(Sex_Male = 0, 
         Sex_Female = 1)

model_sexf = model_counter(data = data_sexf,
                           u_d = u_d, 
                           u_j = u_j, 
                           iter = 2000, 
                           chains = 4, 
                           seed = 234578481)

pred_sexf = prediction_counter(params_df = model_sexf$params, 
                               data = data_sexf, 
                               seed = 3588495,
                               color_nr = 1, 
                               plot_text = "Intervention Sex -> Female", 
                               plot_text_bin = "Female", 
                               plot_org_logit = pred_sexm$plot_comp_logit, 
                               plot_org_bin = pred_sexm$plot_comp_bin)


bin_colors = unique(ggplot_build(pred_sexf$plot_comp_bin)$data[[1]]["fill"])

sex_comp_logit = pred_sexf$plot_comp_logit +
                    geom_label(x = 0.58, y = 2, label = "Original", color = bin_colors[1,1]) +
                    geom_label(x = 0.08, y = 1.4, label = "Male", color = bin_colors[2,1]) +
                    geom_label(x = 0.8, y = 1.25, label = "Female", color = bin_colors[3,1]) 

sex_comp_logit
pred_sexf$plot_comp_bin
```

```{r}
saveRDS(model_sexf, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "07_model_sexf.rds")
        )

saveRDS(pred_sexf, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "08_pred_sexf.rds")
        )

model_sexf = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                 "07_model_sexf.rds")
                    )

pred_sexf = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "08_pred_sexf.rds")
                   )
```

##### Intervention on Race: all cases are now white

```{r}
data_racewhite = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_Caucasian = 1) 


model_racewhite = model_counter(data = data_racewhite,
                                u_d = u_d, 
                                u_j = u_j, 
                                iter = 2000,
                                chains = 4, 
                                seed = 98324757)

pred_racewhite = prediction_counter(params_df = model_racewhite$params, 
                                    data = data_racewhite, 
                                    color_nr = 3, 
                                    seed = 49586783,
                                    plot_text = "Intervention Race -> White", 
                                    plot_text_bin = "White", 
                                    plot_org_logit = pred_base$plot_counter_logit, 
                                    plot_org_bin = pred_base$plot_counter_bin)
```

```{r}
saveRDS(model_racewhite, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "09_model_racewhite.rds")
        )

saveRDS(pred_racewhite, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "10_pred_racewhite.rds")
        )

model_racewhite = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "09_model_racewhite.rds")
                    )

pred_racewhite = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "10_pred_racewhite.rds")
                   )
```

##### Intervention on Race: all cases are now black

```{r}
data_raceblack = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_African_American = 1) 


model_raceblack = model_counter(data = data_raceblack,
                                u_d = u_d, 
                                u_j = u_j, 
                                iter = 2000, 
                                chains = 4, 
                                seed = 138971459)

pred_raceblack = prediction_counter(params_df = model_raceblack$params, 
                                    data = data_raceblack, 
                                    seed = 34897453,
                                    color_nr = 1, 
                                    plot_text = "Intervention Race -> Black", 
                                    plot_text_bin = "Black", 
                                    plot_org_logit = pred_racewhite$plot_comp_logit, 
                                    plot_org_bin = pred_racewhite$plot_comp_bin)

bin_colors = unique(ggplot_build(pred_raceblack$plot_comp_bin)$data[[1]]["fill"])

race_wb_comp_logit = pred_raceblack$plot_comp_logit +
                        geom_label(x = 0.1, y = 1.3, label = "Original", color = bin_colors[1,1]) +
                        geom_label(x = 0.8, y = 1.8, label = "White", color = bin_colors[2,1]) +
                        geom_label(x = 1, y = 1.3, label = "Black", color = bin_colors[3,1]) 

race_wb_comp_logit
pred_raceblack$plot_comp_bin
```

```{r}
saveRDS(model_raceblack, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "11_model_raceblack.rds")
        )

saveRDS(pred_raceblack, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "12_pred_raceblack.rds")
        )

model_raceblack = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "11_model_raceblack.rds")
                    )

pred_raceblack = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "12_pred_raceblack.rds")
                   )
```

##### Intervention on Race: all cases are now asian

```{r}
data_raceasian = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_Asian = 1) 


model_raceasian = model_counter(data = data_raceasian,
                                u_d = u_d, 
                                u_j = u_j, 
                                iter = 2000,
                                chains = 4,
                                seed = 2468973)

pred_raceasian = prediction_counter(params_df = model_raceasian$params, 
                                    data = data_raceasian, 
                                    seed = 39485727,
                                    color_nr = 1, 
                                    plot_text = "Intervention Race -> Asian", 
                                    plot_text_bin = "Asian", 
                                    plot_org_logit = pred_racewhite$plot_comp_logit, 
                                    plot_org_bin = pred_racewhite$plot_comp_bin)

bin_colors = unique(ggplot_build(pred_raceasian$plot_comp_bin)$data[[1]]["fill"])

race_wa_comp_logit = pred_raceasian$plot_comp_logit +
                        geom_label(x = 0.58, y = 2, label = "Original", color = bin_colors[1,1]) +
                        geom_label(x = 0.08, y = 1.4, label = "White", color = bin_colors[2,1]) +
                        geom_label(x = 0.88, y = 1.25, label = "Asian", color = bin_colors[3,1]) 

race_wa_comp_logit
pred_raceasian$plot_comp_bin
```

```{r}
saveRDS(model_raceasian, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "13_model_raceasian.rds")
        )

saveRDS(pred_raceasian, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "14_pred_raceasian.rds")
        )

model_raceasian = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "13_model_raceasian.rds")
                    )

pred_raceasian = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "14_pred_raceasian.rds")
                   )
```

##### Intervention on Race: all cases are now hispanic

```{r}
data_racehisp = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_Hispanic = 1) 


model_racehisp = model_counter(data = data_racehisp,
                               u_d = u_d, 
                               u_j = u_j, 
                               iter = 2000, 
                               chains = 4,
                               seed = 23498573)

pred_racehisp = prediction_counter(params_df = model_racehisp$params, 
                                   data = data_racehisp, 
                                   seed = 28975065,
                                   color_nr = 1, 
                                   plot_text = "Intervention Race -> Hispanic", 
                                   plot_text_bin = "Hispanic", 
                                   plot_org_logit = pred_racewhite$plot_comp_logit, 
                                   plot_org_bin = pred_racewhite$plot_comp_bin)

bin_colors = unique(ggplot_build(pred_racehisp$plot_comp_bin)$data[[1]]["fill"])

race_wh_comp_logit = pred_racehisp$plot_comp_logit +
                        geom_label(x = 0.58, y = 2, label = "Original", color = bin_colors[1,1]) +
                        geom_label(x = 0.08, y = 1.4, label = "White", color = bin_colors[2,1]) +
                        geom_label(x = 0.88, y = 1.25, label = "Hispanic", color = bin_colors[3,1]) 

race_wh_comp_logit
pred_racehisp$plot_comp_bin
```

```{r}
saveRDS(model_racehisp, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "15_model_racehisp.rds")
        )

saveRDS(pred_racehisp, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "16_pred_racehisp.rds")
        )

model_racehisp = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "15_model_racehisp.rds")
                    )

pred_racehisp = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                "16_pred_racehisp.rds")
                   )
```

##### Intervention on Race: all cases are now natives

```{r}
data_racenative = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_Native_American = 1) 


model_racenative = model_counter(data = data_racenative,
                                 u_d = u_d, 
                                 u_j = u_j, 
                                 iter = 2000, 
                                 chains = 4, 
                                 seed = 3428927)

pred_racenative = prediction_counter(params_df = model_racenative$params, 
                                     data = data_racenative,
                                     seed = 43897923,
                                     color_nr = 1, 
                                     plot_text = "Intervention Race -> Native", 
                                     plot_text_bin = "Native", 
                                     plot_org_logit = pred_racewhite$plot_comp_logit, 
                                     plot_org_bin = pred_racewhite$plot_comp_bin)

bin_colors = unique(ggplot_build(pred_racenative$plot_comp_bin)$data[[1]]["fill"])

race_wn_comp_logit = pred_racenative$plot_comp_logit +
                        geom_label(x = 0.58, y = 2, label = "Original", color = bin_colors[1,1]) +
                        geom_label(x = 0.08, y = 1.4, label = "White", color = bin_colors[2,1]) +
                        geom_label(x = 0.88, y = 1.25, label = "Native", color = bin_colors[3,1]) 

race_wn_comp_logit
pred_racenative$plot_comp_bin
```

```{r}
saveRDS(model_racenative, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "17_model_racenative.rds")
        )

saveRDS(pred_racenative, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "18_pred_racenative.rds")
        )

model_racenative = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                 "17_model_racenative.rds")
                    )

pred_racenative = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "18_pred_racenative.rds")
                   )
```

##### Intervention on Race: all cases are now other races

```{r}
data_raceother = data_counter %>% 
  mutate(across(.cols = starts_with("Race"),
                .fns = ~ 0)) %>% 
  mutate(Race_Other = 1) 


model_raceother = model_counter(data = data_raceother,
                                u_d = u_d, 
                                u_j = u_j, 
                                iter = 2000, 
                                chains = 4, 
                                seed = 94858385)

pred_raceother = prediction_counter(params_df = model_raceother$params, 
                                    data = data_raceother,
                                    seed = 455927483,
                                    color_nr = 1, 
                                    plot_text = "Intervention Race -> Other", 
                                    plot_text_bin = "Other", 
                                    plot_org_logit = pred_racewhite$plot_comp_logit, 
                                    plot_org_bin = pred_racewhite$plot_comp_bin)

bin_colors = unique(ggplot_build(pred_raceother$plot_comp_bin)$data[[1]]["fill"])

race_wo_comp_logit = pred_raceother$plot_comp_logit +
                        geom_label(x = 0.58, y = 2, label = "Original", color = bin_colors[1,1]) +
                        geom_label(x = 0.08, y = 1.4, label = "White", color = bin_colors[2,1]) +
                        geom_label(x = 0.88, y = 1.25, label = "Other", color = bin_colors[3,1]) 

race_wo_comp_logit
pred_raceother$plot_comp_bin
```

```{r}
saveRDS(model_raceother, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "19_model_raceother.rds")
        )

saveRDS(pred_raceother, 
        file = here("01_data", "02_data_processed", "04_counterfactual", 
                    "20_pred_raceother.rds")
        )

model_raceother = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                 "19_model_raceother.rds")
                    )

pred_raceother = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual", 
                                "20_pred_raceother.rds")
                   )
```

### Save graphs
```{r}

```


## Post-Processing: ROC-Pivot
Function for theta calculation
```{r}
normal_function = function(logit){
  output = ifelse(logit >= 0.5, 1, 0)
  return(output)
}

rejected_function = function(data, privileged){
  
  d = data %>% 
    select(all_of(privileged))
  
  output = ifelse(d == 1, 1, 0)
  
  return(output)
}

diff_calc = function(theta,
                     data_priv,
                     data_logit_priv,
                     data, 
                     data_logit, 
                     prot, 
                     priv){
  
  upper = 0.5 + theta
  lower = 0.5 - theta
  
  d_priv = data_priv %>% 
    mutate(logit = data_logit_priv) %>% 
    select(starts_with(prot),
           logit)
  
  d_priv_count = d_priv %>% 
    mutate(bin = ifelse((logit < lower | logit > upper),
                    normal_function(logit),
                    rejected_function(data = ., privileged = priv))
           ) %>% 
    group_by(bin) %>% 
    summarise(n_priv = n())
  
  diffs = c()
  
  for (i in 1:length(data)) {
    d_unpriv = data[[i]] %>% 
      mutate(logit = data_logit[[i]]) %>% 
      select(starts_with(prot),
             logit)
    
    d_unpriv_count = d_unpriv %>% 
      mutate(bin = ifelse((logit < lower | logit > upper),
                      normal_function(logit),
                      rejected_function(data = ., privileged = priv))
             ) %>% 
      group_by(bin) %>% 
      summarise(n_unpriv = n())
    
    diffs[i] = abs(d_unpriv_count$n_unpriv[1] - d_priv_count$n_priv[1])
  }
  
  diff = sum(diffs)
  
  return(diff)
}

theta_calc = function(theta_lower = 0,
                      theta_upper = 0.1,
                      step = 0.001,
                      data_priv,
                      data_logit_priv,
                      data, 
                      data_logit, 
                      prot, 
                      priv){
  
  grid = seq(theta_lower, theta_upper, step)
  
  df = data.frame(theta = grid,
                  diff = NA)

  for(i in 1:length(grid)){
    df$diff[i] = diff_calc(theta = df$theta[i],
                           data_priv = data_priv,
                           data_logit_priv = data_logit_priv,
                           data = data, 
                           data_logit = data_logit,
                           prot = prot,
                           priv = priv)
  }
  
  output = df %>% 
    filter(diff == min(diff)) %>% 
    as.list()
  
  return(output)
}

```

Function for ROC-corrected prediction & plotting COMPAS score
```{r}
prediction_roc = function(data_logit, 
                          data,
                          theta,
                          priv,
                          seed = 3928567, 
                          color_nr,
                          plot_text,
                          plot_text_bin,
                          plot_text_bin_other = NULL,
                          plot_org_bin = NULL){
  
  # Calculate predicted values for COMPAS score
  set.seed(seed)
  
  upper = 0.5 + theta
  lower = 0.5 - theta
  
  data_with_logit = data %>% 
    mutate(logit = data_logit)
  
  counter_pred = ifelse((data_with_logit$logit < lower | data_with_logit$logit > upper),
                        normal_function(data_with_logit$logit),
                        rejected_function(data = data_with_logit, privileged = priv))
  
  ## Plots for predictions
  colors = wes_palette("Darjeeling1")
  
  # Plot for predicted COMPAS score
  plot_counter_bin = counter_pred %>% 
    as_tibble() %>% 
    group_by(value) %>% 
    summarise(n = n()) %>% 
    mutate(value = factor(value, levels = c(0,1), labels = c("Low", "High"))) %>% 
    ggplot(aes(x = value, y = n)) +
    geom_col(fill = colors[color_nr]) +
    labs(title = "Predicted Values for COMPAS Score",
         subtitle = paste0("Absolute Frequency of Predicted Score Values for ", plot_text),
         x = "COMPAS Score",
         y = "Predicted Frequency") 
  
  ## Plots for comparison of model predictions and base model predictions
  plot_comp_bin = NULL
  
  # Plot for comparison of predicted COMPAS scores in model and base model
  if(!is.null(plot_org_bin)){
    
    counter_pred_plot = counter_pred %>% 
      as_tibble() %>% 
      group_by(value) %>% 
      summarise(n = n()) %>% 
      mutate(value = factor(value, levels = c(0,1), labels = c("Low", "High")),
             Data = factor(plot_text_bin))
    
  if(ncol(plot_org_bin$data) == 2){
       plot_comp_bin = plot_org_bin$data %>% 
        mutate(Data = factor(plot_text_bin_other)) %>% 
        rbind(counter_pred_plot) %>% 
        group_by(Data) %>% 
        ggplot(aes(x = value, y = n, fill = Data)) +
        geom_col(position = position_dodge(0.82), width = 0.8) +
        labs(title = "Comparison of Predicted Values for COMPAS Score (ROC-corrected)",
             subtitle = paste0("Frequency of Predicted Score Values for ROC-corrected Intervention Data"),
             x = "COMPAS Score",
             y = "Predicted Frequency") +
        scale_fill_manual(values = c(unique(ggplot_build(plot_org_bin)$data[[1]]["fill"])[["fill"]],
                                     colors[color_nr]))
    } else {
      plot_comp_bin = plot_org_bin$data %>% 
        rbind(counter_pred_plot) %>% 
        group_by(Data) %>% 
        ggplot(aes(x = value, y = n, fill = Data)) +
        geom_col(position = position_dodge(0.82), width = 0.8) +
        labs(title = "Comparison of Predicted Values for COMPAS Score",
             subtitle = paste0("Frequency of Predicted Score Values for Original Data & Intervention Data"),
             x = "COMPAS Score",
             y = "Predicted Frequency") +
        scale_fill_manual(values = c(as.vector(unique(ggplot_build(plot_org_bin)$data[[1]]["fill"])[["fill"]]),
                                     colors[color_nr]))
    }
  }
  
  # Output list
  output = list(counter_pred = counter_pred,
                plot_counter_bin = plot_counter_bin,
                plot_comp_bin = plot_comp_bin)
  
  return(output)
}
```


### Calculate theta for Sex
```{r}
theta_calc(theta_lower = 0,
           theta_upper = 0.1,
           step = 0.001,
           data_priv = data_sexm,
           data_logit_priv = pred_sexm$counter_pred_logit,
           data = list(data_sexf), 
           data_logit = list(pred_sexf$counter_pred_logit),
           prot = "Sex", priv = "Sex_Male")

diff_calc(theta = 0.1,
          data_priv = data_sexm,
          data_logit_priv = pred_sexm$counter_pred_logit,
          data = list(data_sexf), 
          data_logit = list(pred_sexf$counter_pred_logit),
          prot = "Sex", priv = "Sex_Male")

theta_sex = 0
```

```{r}
plot_sex_logit = pred_sexf$plot_comp_logit

plot_sex_logit +
  annotate("rect", xmin = 0.5 - theta_sex, xmax = 0.5 + theta_sex,
           ymin = layer_scales(plot_sex_logit)$y$get_limits()[1], 
           ymax = layer_scales(plot_sex_logit)$y$get_limits()[2],
           alpha = 0.5,
           fill = colors[5]) +
  annotate("text", 
           x = 0.5,
           y = layer_scales(plot_sex_logit)$y$get_limits()[2] + 0.1, 
           label = "Critical Zone", 
           color = colors[5])
```

```{r}
roc_sexm = prediction_roc(data_logit = pred_sexm$counter_pred_logit, 
                          data = data_sexm,
                          theta = 0,
                          priv = "Sex_Female",
                          seed = 3928567, 
                          color_nr = 3, 
                          plot_text = "Intervention Sex -> Male", 
                          plot_text_bin = "Male",
                          plot_text_bin_other = NULL,
                          plot_org_bin = NULL)

roc_sexf = prediction_roc(data_logit = pred_sexf$counter_pred_logit, 
                          data = data_sexf,
                          theta = 0,
                          priv = "Sex_Female",
                          seed = 3928567, 
                          color_nr = 1, 
                          plot_text = "Intervention Sex -> Female", 
                          plot_text_bin = "Female", 
                          plot_text_bin_other = "Male",
                          plot_org_bin = roc_sexm$plot_counter_bin)

roc_sexf$plot_comp_bin


p = roc_sexm$plot_counter_bin

ggplot_build(p)
```
### Calculate theta for Race
```{r}
theta_calc(theta_lower = 0,
           theta_upper = 0.1,
           step = 0.001,
           data_priv = data_racewhite,
           data_logit_priv = pred_racewhite$counter_pred_logit,
           data = list(data_raceblack, 
                       data_raceasian,
                       data_racehisp,
                       data_racenative,
                       data_raceother), 
           data_logit = list(pred_raceblack$counter_pred_logit, 
                             pred_raceasian$counter_pred_logit,
                             pred_racehisp$counter_pred_logit, 
                             pred_racenative$counter_pred_logit,
                             pred_raceother$counter_pred_logit),
           prot = "Race", priv = "Race_Caucasian")

diff_calc(theta = 0.1,
          data_priv = data_racewhite,
          data_logit_priv = pred_racewhite$counter_pred_logit,
          data = list(data_raceblack, 
                      data_raceasian,
                      data_racehisp,
                      data_racenative,
                      data_raceother),
          data_logit = list(pred_sexm$counter_pred_logit, pred_sexf$counter_pred_logit),
          data_logit = list(pred_raceblack$counter_pred_logit, 
                            pred_raceasian$counter_pred_logit,
                            pred_racehisp$counter_pred_logit, 
                            pred_racenative$counter_pred_logit,
                            pred_raceother$counter_pred_logit),
          prot = "Race", priv = "Race_Caucasian")

theta_race = NA
```



```{r}
sexm_eval = data_base %>% 
  mutate(logit = pred_base$counter_pred_logit,
         bin = pred_base$counter_pred,
         logit_sexm = pred_sexm$counter_pred_logit,
         bin_sexm = pred_sexm$counter_pred) %>% 
  mutate(logit_diff = logit-logit_sexm,
         bin_diff = factor(bin-bin_sexm)) 

hist(sexm_eval$logit_diff)
barplot(table(sexm_eval$bin_diff))

```


