---
title: "Counterfactual Fairness"
author: "Simon Schrauth"
date: "`r Sys.Date()`"
output: html_document
---

# Counterfactual Fairness

## Goal

After executing this script, the counterfactual fairness/discrimination of the base model should be determined.

## Install packages

Installing rstan package (and the dependent StanHeaders package) from source 
(for additional information or in the case of installation problems see also https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started)

```{r}
install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```


```{r}
pacman::p_load(tidyverse, 
               here,
               fastDummies,
               dagitty,
               ggdag,
               rstan,
               wesanderson,
               ggdist,
               ggformula)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## Load data

```{r}
data_train = readRDS(here("01_data", "02_data_processed", "01_base_model",
                          "04_data_train.rds"))
```

## Prepare data
```{r}
data_counter = data_train %>% 
  select(Age = age,
         Sex = sex,
         Race = race,
         JuvFel = juv_fel_count,
         JuvMisd = juv_misd_count,
         Priors = priors_count,
         Crime = charge_degree,
         COMPAS = compas) %>% 
  dummy_cols(select_columns = c("Race", "Sex"),
             remove_first_dummy = FALSE,
             remove_selected_columns = TRUE) %>% 
  rename("Race_Native_American" = "Race_Native American",
         "Race_African_American" = "Race_African-American") %>% 
  mutate(Crime = ifelse(Crime == "F", 1, 0),
         COMPAS = ifelse(COMPAS == "High", 1, 0)) 

colors = wes_palette("Darjeeling1")
```


## Build DAG (directed acyclic graph)
```{r}
dag = dagitty('dag {
  Age [exposure,pos="0,-2"]
  Sex [pos="0,-1"]
  Race [pos="0,0"]
  Priors [pos="0.5, -1.75"]
  Crime [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JuvMisd [pos="0.5, -0.25"]
  JuvFel [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  
  Race -> Priors
  Race -> Crime
  Race -> JuvMisd
  Race -> JuvFel
  Race -> COMPAS
  Sex -> Priors
  Sex -> Crime
  Sex -> JuvMisd
  Sex -> JuvFel
  Sex -> COMPAS
  Age -> Priors
  Age -> Crime
  Age -> JuvMisd
  Age -> JuvFel
  Age -> COMPAS
  U_D -> Priors
  U_D -> Crime
  U_J -> JuvMisd
  U_J -> JuvFel
  U_D -> COMPAS
  }')

#tidy_dagitty(dag)

dag_plot = tidy_dagitty(dag) %>% 
  mutate(name = str_replace(name, "U_J", "U[J]")) %>% 
  mutate(name = str_replace(name, "U_D", "U[D]")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == "COMPAS"),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]"),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to != "COMPAS"),
                          curvature = 1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Sex", "Age")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name=="COMPAS"),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Priors", 
                                                         "Crime",
                                                         "JuvMisd",
                                                         "JuvFel")),
                color = colors[4]) +
  geom_dag_text(size = 2.2, parse = TRUE) +
  theme_dag()

dag_plot

```

```{r}
ggsave("01_dag.png",
       plot = dag_plot,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```


## Build Structural Causal Model via Bayesian Estimation
## with RStan (adapted code from https://github.com/mkusner/counterfactual-fairness)

# Prepare data for modelling with Stan
```{r}
data_counter_protected = data_counter %>% 
  select(starts_with(c("Race_", "Sex_"))) 

n = nrow(data_counter)


data_counter_list = list(N = n,
                         K = length(data_counter_protected),
                         prot = data.matrix(data_counter_protected),
                         age = data_counter[, "Age", drop = TRUE],
                         priors = data_counter[, "Priors", drop = TRUE],
                         crime = data_counter[, "Crime", drop = TRUE],
                         juvmisd = data_counter[, "JuvMisd", drop = TRUE],
                         juvfel = data_counter[, "JuvFel", drop = TRUE],
                         compas = data_counter[, "COMPAS", drop = TRUE])
```

# Fit model
```{r}
fit_counter = stan(file = here("02_scripts", "04_counterfactual",
                               "02_counterfactual_model_stan.stan"), 
                    data = data_counter_list, 
                    iter = 200, # mind. 2000!!!
                    chains = 4,
                    seed = 1216334198,
                    verbose = TRUE)

params_counter = extract(fit_counter)
```



# Save model
```{r}
saveRDS(fit_counter, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "01_model_counter_fit.rds")
        )

saveRDS(params_counter, 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "02_model_counter_params.rds")
        )

fit_counter = readRDS( 
        file = here("01_data", "02_data_processed", "04_counterfactual",
                    "01_model_counter_fit.rds")
        )

params_counter = readRDS(file = here("01_data", "02_data_processed", "04_counterfactual",
                                     "02_model_counter_params.rds")
        )
```

# Plot model weights
```{r}
param_names = function(col){

  pattern = c("_prot\\[1\\]", 
              "_prot\\[2\\]",
              "_prot\\[3\\]",
              "_prot\\[4\\]",
              "_prot\\[5\\]",
              "_prot\\[6\\]",
              "_prot\\[7\\]",
              "_prot\\[8\\]")
  
  replacement = c("_Race: Caucasian",
                  "_Race: African-American",
                  "_Race: Asian",
                  "_Race: Hispanic",
                  "_Race: Native-American",
                  "_Race: Other",
                  "_Sex: Male",
                  "_Sex: Female")
  
  for (i in 1:length(pattern)){
    col = str_replace(col, pattern[i], replacement[i])
  }
  
  return(col)
}

plot_weights = fit_counter %>% 
                        as.data.frame() %>% 
                        select(starts_with("compas"),
                               -c("compas_age")) %>% 
                        rename_with(.cols = everything(), 
                                    .fn = ~ param_names(.x)) %>% 
                        rename_with(.cols = everything(), 
                                    .fn = ~ str_replace(.x, "compas_", "")) %>% 
                        rename_with(.cols = everything(), 
                                    .fn = ~ str_replace(.x, "bias", "Bias")) %>% 
                        rename_with(.cols = everything(), 
                                    .fn = ~ str_replace(.x, "ud", "Ud")) %>%   
                        pivot_longer(cols = everything()) %>%
                        ggplot(aes(x = name, y = value, fill = name)) +
                          ggdist::stat_halfeye(
                          adjust = 0.75,
                          justification = -.05,
                          .width = 0,
                          point_colour = NA
                        ) +
                        geom_boxplot(
                          width = .12,
                          outlier.colour = NA,
                          alpha = 0.5
                        ) +
                        geom_abline(intercept = 0, slope = 0) +
                        scale_fill_manual(values = colors_discrete) +
                        guides(fill = "none") +
                        labs(title = "Posterior Distribution of Model Weights",
                             subtitle = "Only Weights for COMPAS Equation (without Age)",
                             y = "Weight Value",
                             x = "Weight for COMPAS Prediction") +
                        ylim(-2.5, 3) + ###anpassen!!!!
                        coord_flip() 
                        

plot_weights_age = fit_counter %>% 
                            as.data.frame() %>% 
                            select(c("compas_age")) %>% 
                            rename_with(.cols = everything(), 
                                        .fn = ~ str_replace(.x, "compas_age", "Age")) %>% 
                            pivot_longer(cols = everything()) %>%
                            ggplot(aes(x = name, y = value, fill = name)) +
                              ggdist::stat_halfeye(
                              adjust = 0.75,
                              justification = -.05,
                              .width = 0,
                              point_colour = NA
                            ) +
                            geom_boxplot(
                              width = .12,
                              outlier.colour = NA,
                              alpha = 0.5
                            ) +
                            geom_abline(intercept = 0, slope = 0) +
                            scale_fill_manual(values = colors_discrete) +
                            guides(fill = "none") +
                            labs(title = "Posterior Distribution of Model Weights",
                                 subtitle = "Only Weights for COMPAS Equation (only Age)",
                                 y = "Weight Value",
                                 x = "Weight for COMPAS Prediction") +
                            ylim(-0.5, 0) + ###anpassen!!!!
                            coord_flip()

table_weights = fit_counter %>% 
                  as.data.frame() %>% 
                  select(-starts_with("u_d"), 
                         -starts_with("u_j"), 
                         -lp__) %>% 
                  rename_with(.cols = everything(), 
                              .fn = ~ param_names(.x)) %>% 
                  summarise(across(everything(),
                                   list(median = median,
                                        mad = mad))) %>% 
                  round(digits = 2) %>% 
                  pivot_longer(cols = everything(),
                               names_to = c("variable",
                                            "metric"),
                               names_pattern = "(.*)_([a-z]*)$") %>% 
                  pivot_wider(names_from = "variable") %>% 
                  column_to_rownames(var = "metric")

```

```{r}
ggsave("02_plot_weights.png",
       plot = plot_weights,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 40,
       height = 30,
       units = c("cm")
       )

ggsave("03_plot_weights_age.png",
       plot = plot_weights_age,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 10,
       units = c("cm")
       )

```



# Prediction
# adapted code from https://medium.com/@alex.pavlakis/making-predictions-from-stan-models-in-r-3e349dfac1ed
```{r}
gen_quant_r = function(data, params_df, fun){
  params_df_new = params_df %>% 
    select(starts_with(c("u_", "compas_")))
  params_ind = sample(seq(1, nrow(params_df_new)), size = nrow(data), replace = TRUE) 
  params = params_df[params_ind,]
  param_prot = params %>% 
    select(starts_with("compas_prot"))
  
  data_prot = data %>% 
    select(starts_with(c("Race_", "Sex_"))) %>% 
    as.matrix()
  
  data_ud = params %>% 
    select(starts_with("u_d")) %>% 
    as.matrix() %>% 
    t()
  
  inv_logit_raw = matrix(NA,
                         nrow = nrow(data),
                         ncol = ncol(data_ud)) 
  
  for (i in 1:ncol(data_ud)) {
      lin_comb = params$compas_bias + params$compas_age * data$Age + 
             rowSums(param_prot * data_prot) +
             as.vector(params$compas_ud * data_ud[,i])
  
      inv_logit_raw[,i] = 1/(1 + exp(-lin_comb))
  }

  inv_logit = apply(inv_logit_raw, 1, fun)
  
  return(inv_logit)
}

set.seed(239845783)
counter_pred_logit_base = gen_quant_r(params_df = params_counter %>% as.data.frame(),
                                      data = data_counter,
                                      fun = "median")

threshold = 0.5

counter_pred_base = ifelse(counter_pred_logit_base >= threshold, 1, 0)
```

```{r}
accuracy = mean((counter_pred_base == data_counter$COMPAS))
accuracy

colors = wes_palette("Darjeeling1")

plot_counter_pred_logit_base = counter_pred_logit_base %>% 
  as_tibble() %>% 
  rename(logit = value) %>% 
  ggplot(aes()) +
  geom_histogram(aes(x = logit, y = after_stat(density)), 
                 bins = 30, 
                 fill = colors[2],
                 alpha = 0.3) +
  geom_density(aes(x = logit),
               size = 1,
               color = colors[2]) +
  labs(title = "Predicted Values for Probabilites of a High COMPAS Score",
       subtitle = "Histogram and Density Function for Original Data",
       x = "Predicted Probability of a High COMPAS Score",
       y = "Density") 
  

plot_counter_pred_base = counter_pred_base %>% 
  as_tibble() %>% 
  group_by(value) %>% 
  summarise(n = n()) %>% 
  mutate(value = factor(value, levels = c(0,1), labels = c("Low", "High"))) %>% 
  ggplot(aes(x = value, y = n)) +
  geom_col(fill = colors[2]) +
  labs(title = "Predicted Values for COMPAS Score",
       subtitle = "Absolute Frequency of Predicted Score Values for Original Data",
       x = "COMPAS Score",
       y = "Predicted Frequency")
```
 
```{r}
ggsave("04_plot_counter_pred_logit_base.png",
       plot = plot_counter_pred_logit_base,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )

ggsave("05_plot_counter_pred_base.png",
       plot = plot_counter_pred_base,
       device = "png",
       path = here("03_outputs", "04_counterfactual"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```

## Counterfactual Analysis

```{r}

```

