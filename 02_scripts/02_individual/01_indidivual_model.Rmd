---
title: "Individual Fairness Model"
author: "Simon Schrauth"
date: "`r Sys.Date()`"
output: html_document
---
# Individual

## Goal

After executing this script, the individual fairness/discrimination of the base model should be determined.

## Preparation
### Install packages
```{r}
pacman::p_load(tidyverse, 
               here,
               tidymodels,
               cluster,
               scales,
               MLmetrics,
               wesanderson)

tidymodels_prefer()
```

### Load data
```{r}
data = readRDS(here("01_data", "02_data_processed", "01_base_model",
                    "03_data.rds"))

model_fit = readRDS(file = here("01_data", "02_data_processed", "01_base_model",
                                "04_model_fit.rds"))
```

### Source Function Script
```{r}
source(file = here("02_scripts", "02_individual", "00_individual_functions.R"))
```

## Model Calculation
### Estimate model with custom optimization algorithm
```{r}
data_prep = recipe(compas ~ .,
                         data = data) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  prep() %>% 
  bake(new_data = NULL) %>% 
  mutate(compas = as.numeric(compas)-1)

model_base = glm(compas ~ ., 
                 data = data_prep, 
                 family = binomial(link = "logit"),
                 method = my_method)

model_base_summary = data.frame(estimate = model_base$coefficients,
                                se = as.vector(model_base$se),
                                z = model_base$z,
                                p_value = model_base$p)

model_base_summary %>% 
    slice(-1) %>% 
    mutate(estimate = exp(estimate)) %>% 
    mutate(estimate_percent = percent((estimate - 1), digits = 1)) %>% 
    relocate(estimate_percent, .after = estimate)
```

### Calculate individual discrimination
```{r}
# extract probabilities out of base model
base_prob = my_predict(summary = model_base_summary, 
                       data = data_prep)

# calculate proportion of cases where individual fairness is not given (D(Mx, My) > d(x,y))
dist_base = diff_dist(prob = base_prob, 
                      data = data)

dist_base$n_unfair_rel
```

### Save output
```{r}
saveRDS(model_base,
        file = here("01_data", "02_data_processed", "02_individual", 
                    "01_model_base.rds"))

saveRDS(dist_base,
        file = here("01_data", "02_data_processed", "02_individual", "big_data",
                    "01_dist_base.rds"))
```
```{r}
model_base = readRDS(file = here("01_data", "02_data_processed", "02_individual", 
                                 "01_model_base.rds"))

dist_base = readRDS(file = here("01_data", "02_data_processed", "02_individual", "big_data",
                                "01_dist_base.rds"))
```


## In-Processing
### Hyper-Parameter Tuning (lambda)
```{r}
lambdas = seq(-150, 0, 30)
# in functions von 2 auf 100!!!!

results_fair = c()

results_acc = c()

for (lambda in lambdas) {
  print(paste("Lambda:", lambda))
  
  model_temp = glm(compas ~ ., 
                   data = data_prep, 
                   family = binomial(link = "logit"),
                   method = my_method_with_penalty,
                   control = list(lambda = lambda,
                                  penalty_function = my_penalty_function))

  model_temp_summary = data.frame(estimate = model_temp$coefficients,
                                  se = as.vector(model_temp$se),
                                  z = model_temp$z,
                                  p_value = model_temp$p)
  
  pen_prob = my_predict(summary = model_temp_summary, 
                        data = data_prep)
  

  dist_linf_pen = diff_dist(prob = pen_prob, 
                            data = data)
  
  logloss = LogLoss(pen_prob$low, data_prep$compas)
  
  results_fair = append(results_fair, values = dist_linf_pen$n_unfair_rel)
  results_acc = append(results_acc, values = logloss)
}

hyperparam_results = data.frame(Lambda = lambdas,
                                Fairness_Metrik = results_fair,
                                Log_Loss = results_acc) %>% 
  mutate(Kosten_Funktion = Log_Loss + Lambda * Fairness_Metrik)

################ noch base_diff als Referenzwert einfügen!!! #########
hyperparam_results %>% 
  pivot_longer(cols = !Lambda) %>% 
  mutate(name = str_replace(name, "_", "-")) %>% 
  ggplot(aes(x = Lambda, y = value, color = name)) +
    geom_point() +
    geom_line() +
  facet_wrap(~factor(name, levels = c("Log-Loss",
                                      "Fairness-Metrik",
                                      "Kosten-Funktion")
                     ), 
             scales = "free_y") +
  scale_color_manual(values = wes_palette("Darjeeling1")) +
  labs(title = "Hyperparameter-Tuning für \u03bb",
       subtitle = "Log-loss, Fairness-Metrik & Kosten-Funktion (Log-loss + \u03bb * Fairness-Metrik) \nbei unterschiedlichen \u03bb-Werten",
       y = "") +
  guides(color = "none")

# nur nach Fairness-Metrik hin optimieren?

final_lambda = -99
```

### Final fair model
```{r}
model_fair = glm(compas ~ ., 
                 data = data_prep, 
                 family = binomial(link = "logit"),
                 method = my_method_with_penalty,
                 control = list(lambda = final_lambda, 
                                penalty_function = my_penalty_function))

model_fair_summary = data.frame(estimate = model_fair$coefficients,
                                se = as.vector(model_fair$se),
                                z = model_fair$z,
                                p_value = model_fair$p)

model_fair_summary %>% 
    slice(-1) %>% 
    mutate(estimate = exp(estimate)) %>% 
    mutate(estimate_percent = percent((estimate - 1), digits = 1)) %>% 
    relocate(estimate_percent, .after = estimate)

```

Calculate individual discrimination
```{r}
# extract probabilities out of base model
pen_prob_fair = my_predict(summary = model_fair_summary, 
                           data = data_prep)

# calculate proportion of cases where individual fairness is not given (D(Mx, My) > d(x,y))
dist_pen_fair = diff_dist(prob = pen_prob_fair, 
                          data = data)

dist_pen_fair$n_unfair_rel
```

Save output
```{r}
saveRDS(model_fair,
        file = here("01_data", "02_data_processed", "02_individual", 
                    "02_model_fair.rds"))

saveRDS(dist_pen_fair,
        file = here("01_data", "02_data_processed", "02_individual", "big_data",
                    "02_dist_pen_fair.rds"))
```

```{r}
model_fair = readRDS(file = here("01_data", "02_data_processed", "02_individual", 
                                 "02_model_fair.rds"))

dist_pen_fair = readRDS(file = here("01_data", "02_data_processed", "02_individual", "big_data",
                               "02_dist_pen_fair.rds"))
```

