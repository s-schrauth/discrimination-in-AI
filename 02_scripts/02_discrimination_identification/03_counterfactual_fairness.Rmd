---
title: "Counterfactual Fairness"
author: "Simon Schrauth"
date: "`r Sys.Date()`"
output: html_document
---

# Counterfactual Fairness

## Goal

After executing this script, the counterfactual fairness/discrimination of the base model should be determined.

## Install packages

Installing rstan package (and the dependent StanHeaders package) from source 
(for additional information or in the case of installation problems see also https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started)

```{r}
install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```


```{r}
pacman::p_load(tidyverse, 
               here,
               fastDummies,
               dagitty,
               ggdag,
               lavaan,
               rstan,
               wesanderson)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## Load data

```{r}
data_train = readRDS(here("01_data", "02_data_processed",
                          "04_data_train.rds"))
```

## Prepare data
```{r}
data_counter = data_train %>% 
  select(Age = age,
         Sex = sex,
         Race = race,
         JuvFel = juv_fel_count,
         JuvMisd = juv_misd_count,
         Priors = priors_count,
         Crime = charge_degree,
         COMPAS = compas) %>% 
  dummy_cols(select_columns = "Race",
             remove_first_dummy = TRUE,
             remove_selected_columns = TRUE) %>% 
  rename("Race_Native_American" = "Race_Native American",
         "Race_African_American" = "Race_African-American") %>% 
  mutate(Sex = ifelse(Sex == "Female", 1, 0),
         Crime = ifelse(Crime == "F", 1, 0),
         COMPAS = ifelse(COMPAS == "High", 1, 0)) 
```


## Build DAG (directed acyclic graph)
```{r}
dag = dagitty('dag {
  Age [exposure,pos="0,-2"]
  Sex [pos="0,-1"]
  Race [pos="0,0"]
  Priors [pos="0.5, -1.75"]
  Crime [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JuvMisd [pos="0.5, -0.25"]
  JuvFel [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  Race -> Priors
  Race -> Crime
  Race -> JuvMisd
  Race -> JuvFel
  Race -> COMPAS
  Sex -> Priors
  Sex -> Crime
  Sex -> JuvMisd
  Sex -> JuvFel
  Sex -> COMPAS
  Age -> Priors
  Age -> Crime
  Age -> JuvMisd
  Age -> JuvFel
  Age -> COMPAS
  U_D -> Priors
  U_D -> Crime
  U_J -> JuvMisd
  U_J -> JuvFel
  U_D -> COMPAS
  }')

colors = wes_palette("Darjeeling1")

dag_plot = tidy_dagitty(dag) %>% 
  mutate(name = str_replace(name, "U_J", "U[J]")) %>% 
  mutate(name = str_replace(name, "U_D", "U[D]")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == "COMPAS"),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]"),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to != "COMPAS"),
                          curvature = 1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Sex", "Age")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name=="COMPAS"),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Priors", 
                                                         "Crime",
                                                         "JuvMisd",
                                                         "JuvFel")),
                 color = colors[4]) +
  geom_dag_text(size = 2.2, parse = TRUE) +
  theme_dag()

dag_plot

tidy_dagitty(dag)
```

```{r}
ggsave("XX_dag.png",
       plot = dag_plot,
       device = "png",
       path = here("03_outputs", "03_outputs_graphs"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```


## Build alternative DAG (directed acyclic graph)
```{r}
dag2 = dagitty('dag {
  Age [exposure,pos="0,-2"]
  Sex [pos="0,-1"]
  Race [pos="0,0"]
  Priors [pos="0.5, -1.75"]
  Crime [pos="1, -1.75"]
  U_D [latent,pos="2, -1.5"]
  JuvMisd [pos="0.5, -0.25"]
  JuvFel [pos="1,-0.25"]
  U_J [latent,pos="2, -0.5"]
  COMPAS [outcome,pos="1.5,-1"]
  Race -> Priors
  Race -> Crime
  Race -> JuvMisd
  Race -> JuvFel
  Race -> COMPAS
  Sex -> Priors
  Sex -> Crime
  Sex -> JuvMisd
  Sex -> JuvFel
  Sex -> COMPAS
  Age -> Priors
  Age -> Crime
  Age -> JuvMisd
  Age -> JuvFel
  Age -> COMPAS
  U_D -> Priors
  U_D -> Crime
  U_J -> JuvMisd
  U_J -> JuvFel
  U_D -> COMPAS
  Priors -> COMPAS
  Crime -> COMPAS
  JuvMisd -> COMPAS
  JuvFel -> COMPAS
  }')

colors = wes_palette("Darjeeling1")

dag2_plot = tidy_dagitty(dag2) %>% 
  mutate(name = str_replace(name, "U_J", "U[J]")) %>% 
  mutate(name = str_replace(name, "U_D", "U[D]")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(data_directed = function(x) subset(x, name != "U[J]" & name != "U[D]")) +
  geom_dag_edges(data_directed = function(x) subset(x, to == "COMPAS"),
                 edge_color = colors[3]) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[J]"),
                          curvature = -1) +
  geom_dag_edges_arc(data = function(x) subset(x, name == "U[D]" & to != "COMPAS"),
                          curvature = 1) +
  geom_dag_node(data = function(x) subset(x, name %in% c("U[J]", "U[D]")),
                 color = colors[2]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Race", "Sex", "Age")),
                 color = colors[5]) +
  geom_dag_node(data = function(x) subset(x, name=="COMPAS"),
                 color = colors[3]) +
  geom_dag_node(data = function(x) subset(x, name %in% c("Priors", 
                                                         "Crime",
                                                         "JuvMisd",
                                                         "JuvFel")),
                 color = colors[4]) +
  geom_dag_text(size = 2.2, parse = TRUE) +
  theme_dag()

dag2_plot

tidy_dagitty(dag2)
```
```{r}
ggsave("XX_dag2.png",
       plot = dag2_plot,
       device = "png",
       path = here("03_outputs", "03_outputs_graphs"),
       dpi = 300,
       width = 25,
       height = 15,
       units = c("cm")
       )
```


## Build Structural Causal Model
```{r}
scm = '
  U_D =~ Priors + Crime
  U_J =~ JuvMisd + JuvFel
  
  COMPAS ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_D + Priors + Crime + JuvMisd + JuvFel
  JuvMisd ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_J 
  JuvFel ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_J
  Priors ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_D
  Crime ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_D
'
```

```{r}
scm = '
  U_D =~ Priors + Crime
  U_J =~ JuvMisd + JuvFel
  
  COMPAS ~ Race_African_American + Race_Asian + Race_Hispanic + Race_Native_American + Race_Other + Sex + Age + U_D 
'
```

```{r}
scm_fit = sem(model = scm,
              data = data_counter)

summary(scm_fit)

lavPredict(scm_fit)
```

```{r}
example(stan_model, package = "rstan", run.dontrun = TRUE)
```

```{r}

```

